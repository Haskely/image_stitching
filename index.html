<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼é•¿å›¾å·¥å…·</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #1d1d1f;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 600;
        }

        .header p {
            color: #86868b;
            font-size: 1.1em;
        }

        .upload-area {
            border: 2px dashed #007aff;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: white;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            background: #f8f9ff;
            border-color: #005ce6;
        }

        .upload-area.dragover {
            background: #e8f4ff;
            border-color: #005ce6;
        }

        .upload-icon {
            font-size: 3em;
            color: #007aff;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #1d1d1f;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: #86868b;
            font-size: 0.9em;
        }

        #fileInput {
            display: none;
        }

        .images-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .images-list {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .preview-area {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1d1d1f;
        }

        .image-item {
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .image-preview {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .crop-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .crop-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .crop-control label {
            min-width: 80px;
            font-weight: 500;
            color: #1d1d1f;
        }

        .crop-control input[type="range"] {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: #d1d1d6;
            outline: none;
            -webkit-appearance: none;
        }

        .crop-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007aff;
            cursor: pointer;
        }

        .crop-control span {
            min-width: 40px;
            text-align: right;
            font-size: 0.9em;
            color: #86868b;
        }

        .remove-btn {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            transition: background 0.2s;
        }

        .remove-btn:hover {
            background: #d70015;
        }

        .final-preview {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        .controls {
            text-align: center;
            margin-top: 30px;
        }

        .btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            margin: 0 10px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #005ce6;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #d1d1d6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: #8e8e93;
        }

        .btn.secondary:hover {
            background: #6d6d70;
        }

        .empty-state {
            text-align: center;
            color: #86868b;
            font-style: italic;
            padding: 40px 20px;
        }

        @media (max-width: 768px) {
            .images-section {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            .upload-area {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ‹¼é•¿å›¾å·¥å…·</h1>
            <p>æ”¯æŒå¤šå¼ å›¾ç‰‡ç«–å‘æ‹¼æ¥ï¼Œæ¯å¼ å›¾ç‰‡ç‹¬ç«‹è£åˆ‡</p>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“¸</div>
            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>
            <div class="upload-hint">æ”¯æŒ JPGã€PNGã€WebP æ ¼å¼</div>
            <input type="file" id="fileInput" multiple accept="image/*">
        </div>

        <div class="images-section">
            <div class="images-list">
                <div class="section-title">å›¾ç‰‡åˆ—è¡¨ (<span id="imageCount">0</span>)</div>
                <div id="imagesList" class="empty-state">
                    è¯·ä¸Šä¼ å›¾ç‰‡å¼€å§‹æ‹¼æ¥
                </div>
            </div>

            <div class="preview-area">
                <div class="section-title">é¢„è§ˆæ•ˆæœ</div>
                <canvas id="previewCanvas" class="final-preview" style="display: none;"></canvas>
                <div id="previewEmpty" class="empty-state">
                    ä¸Šä¼ å›¾ç‰‡åé¢„è§ˆæ•ˆæœå°†åœ¨æ­¤æ˜¾ç¤º
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" id="generateBtn" onclick="generatePreview()" disabled>ç”Ÿæˆé¢„è§ˆ</button>
            <button class="btn secondary" id="clearBtn" onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰</button>
            <button class="btn" id="downloadBtn" onclick="downloadImage()" disabled>ä¸‹è½½å›¾ç‰‡</button>
        </div>
    </div>

    <script>
        let imageFiles = [];
        let imageData = [];

        // DOM å…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagesList = document.getElementById('imagesList');
        const imageCount = document.getElementById('imageCount');
        const previewCanvas = document.getElementById('previewCanvas');
        const previewEmpty = document.getElementById('previewEmpty');
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
        }

        // æ‹–æ‹½å¤„ç†
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            addImages(files.filter(file => file.type.startsWith('image/')));
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            addImages(files);
        }

        // æ·»åŠ å›¾ç‰‡
        function addImages(files) {
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const imageObj = {
                                id: Date.now() + Math.random(),
                                file: file,
                                src: e.target.result,
                                width: img.width,
                                height: img.height,
                                cropTop: 0,
                                cropBottom: 100,
                                name: file.name
                            };
                            imageData.push(imageObj);
                            updateUI();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // æ›´æ–°UI
        function updateUI() {
            updateImagesList();
            updateControls();
            generatePreview();
        }

        // æ›´æ–°å›¾ç‰‡åˆ—è¡¨
        function updateImagesList() {
            imageCount.textContent = imageData.length;
            
            if (imageData.length === 0) {
                imagesList.innerHTML = '<div class="empty-state">è¯·ä¸Šä¼ å›¾ç‰‡å¼€å§‹æ‹¼æ¥</div>';
                return;
            }

            imagesList.innerHTML = imageData.map((img, index) => `
                <div class="image-item" data-id="${img.id}">
                    <img src="${img.src}" alt="${img.name}" class="image-preview">
                    <div class="crop-controls">
                        <div class="crop-control">
                            <label>ä¸Šè¾¹è·:</label>
                            <input type="range" min="0" max="100" value="${img.cropTop}" 
                                   oninput="updateCrop(${img.id}, 'cropTop', this.value)">
                            <span>${img.cropTop}%</span>
                        </div>
                        <div class="crop-control">
                            <label>ä¸‹è¾¹è·:</label>
                            <input type="range" min="0" max="100" value="${100 - img.cropBottom}" 
                                   oninput="updateCrop(${img.id}, 'cropBottom', ${100} - this.value)">
                            <span>${100 - img.cropBottom}%</span>
                        </div>
                    </div>
                    <button class="remove-btn" onclick="removeImage(${img.id})">åˆ é™¤å›¾ç‰‡</button>
                </div>
            `).join('');
        }

        // æ›´æ–°è£åˆ‡å‚æ•°
        function updateCrop(id, property, value) {
            const img = imageData.find(img => img.id === id);
            if (img) {
                img[property] = parseFloat(value);
                updateUI();
            }
        }

        // åˆ é™¤å›¾ç‰‡
        function removeImage(id) {
            imageData = imageData.filter(img => img.id !== id);
            updateUI();
        }

        // æ›´æ–°æ§åˆ¶æŒ‰é’®çŠ¶æ€
        function updateControls() {
            const hasImages = imageData.length > 0;
            generateBtn.disabled = !hasImages;
            downloadBtn.disabled = !hasImages;
        }

        // ç”Ÿæˆé¢„è§ˆ
        function generatePreview() {
            if (imageData.length === 0) {
                previewCanvas.style.display = 'none';
                previewEmpty.style.display = 'block';
                return;
            }

            const canvas = previewCanvas;
            const ctx = canvas.getContext('2d');

            // è®¡ç®—ç”»å¸ƒå°ºå¯¸
            let maxWidth = 0;
            let totalHeight = 0;

            const processedImages = imageData.map(imgData => {
                const cropTopPx = (imgData.height * imgData.cropTop) / 100;
                const cropBottomPx = (imgData.height * imgData.cropBottom) / 100;
                const croppedHeight = cropBottomPx - cropTopPx;
                
                maxWidth = Math.max(maxWidth, imgData.width);
                totalHeight += croppedHeight;

                return {
                    ...imgData,
                    cropTopPx,
                    cropBottomPx,
                    croppedHeight
                };
            });

            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            canvas.width = maxWidth;
            canvas.height = totalHeight;

            // ç»˜åˆ¶å›¾ç‰‡
            let currentY = 0;
            let loadedCount = 0;

            processedImages.forEach(imgData => {
                const img = new Image();
                img.onload = () => {
                    // ç»˜åˆ¶è£åˆ‡åçš„å›¾ç‰‡éƒ¨åˆ†
                    ctx.drawImage(
                        img,
                        0, imgData.cropTopPx, // æºå›¾ç‰‡è£åˆ‡èµ·å§‹ä½ç½®
                        imgData.width, imgData.croppedHeight, // æºå›¾ç‰‡è£åˆ‡å°ºå¯¸
                        0, currentY, // ç›®æ ‡ç”»å¸ƒä½ç½®
                        maxWidth, imgData.croppedHeight // ç›®æ ‡ç”»å¸ƒå°ºå¯¸
                    );
                    
                    loadedCount++;
                    if (loadedCount === processedImages.length) {
                        // æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆï¼Œæ˜¾ç¤ºé¢„è§ˆ
                        previewCanvas.style.display = 'block';
                        previewEmpty.style.display = 'none';
                    }
                };
                img.src = imgData.src;
                currentY += imgData.croppedHeight;
            });
        }

        // ä¸‹è½½å›¾ç‰‡
        function downloadImage() {
            if (imageData.length === 0) return;

            const canvas = previewCanvas;
            const link = document.createElement('a');
            link.download = `æ‹¼é•¿å›¾_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡å—ï¼Ÿ')) {
                imageData = [];
                fileInput.value = '';
                updateUI();
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            updateUI();
        });
    </script>
</body>
</html>